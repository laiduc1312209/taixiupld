import random
import time
import os
from pymongo import MongoClient
import requests

def clear():
    os.system('cls' if os.name == 'nt' else 'clear')

# URI káº¿t ná»‘i MongoDB Atlas vÃ  URL webhook Discord
MONGO_URI = "mongodb+srv://laiduc1312:laiduc2009@cluster0.ktdby.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0"
DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1327548042441658408/-a6LBgKzUJPSFk22eUyqCTZNGTg5YfgqE3HcmaIBfeKsKi4lhgiXr47xgUlCXkrlKwFh"

# Káº¿t ná»‘i MongoDB
client = MongoClient(MONGO_URI)
db = client['game_db']  # TÃªn cÆ¡ sá»Ÿ dá»¯ liá»‡u
players_collection = db['players']  # TÃªn collection

# HÃ m gá»­i thÃ´ng tin tá»›i webhook Discord
def send_to_discord(webhook_url, username, balance):
    role_id = "1327619782211670106"
    data = {
        "content": f"<@&{role_id}> \nğŸ® **TÃ i khoáº£n**: {username}\nğŸ’° **Sá»‘ dÆ° hiá»‡n táº¡i**: {balance} PLDCoin"
    }
    try:
        response = requests.post(webhook_url, json=data)
        if response.status_code == 204:
            print("âœ… ÄÃ£ gá»­i thÃ´ng tin Ä‘áº¿n Discord!")
        else:
            print(f"âŒ Lá»—i khi gá»­i thÃ´ng tin: {response.status_code} - {response.text}")
    except Exception as e:
        print(f"âš ï¸ CÃ³ lá»—i xáº£y ra khi gá»­i tá»›i Discord: {e}")

# HÃ m Ä‘Äƒng kÃ½ tÃ i khoáº£n
def register():
    username = input("ğŸ”‘ Nháº­p tÃªn tÃ i khoáº£n má»›i: ").strip()
    if username == "":
        print("âš ï¸ TÃªn tÃ i khoáº£n khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.")
        return None
    # Kiá»ƒm tra náº¿u tÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i
    existing_player = players_collection.find_one({"username": username})
    if existing_player:
        print("âŒ TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i. Vui lÃ²ng chá»n tÃªn khÃ¡c.")
        return None
    # Táº¡o tÃ i khoáº£n má»›i vá»›i sá»‘ dÆ° 1000 PLDCoin
    player = {"username": username, "balance": 1000}
    players_collection.insert_one(player)
    print(f"âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! TÃ i khoáº£n {username} Ä‘Æ°á»£c khá»Ÿi táº¡o vá»›i 1000 PLDCoin.")
    return username

# HÃ m Ä‘Äƒng nháº­p
def login():
    username = input("ğŸ”‘ Nháº­p tÃªn tÃ i khoáº£n: ").strip()
    player = players_collection.find_one({"username": username})
    if player:
        print(f"âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng! ChÃ o má»«ng {username} ğŸ‰.")
        return username
    else:
        print("âŒ TÃ i khoáº£n khÃ´ng tá»“n táº¡i. Vui lÃ²ng Ä‘Äƒng kÃ½ trÆ°á»›c.")
        return None

# HÃ m kiá»ƒm tra sá»‘ tiá»n cÆ°á»£c há»£p lá»‡
def valid_bet(balance):
    while True:
        try:
            bet = input(f"ğŸ’¸ Nháº­p sá»‘ tiá»n báº¡n muá»‘n cÆ°á»£c (hoáº·c 'all' Ä‘á»ƒ cÆ°á»£c toÃ n bá»™ {balance} PLDCoin): ").strip().lower()
            if bet == 'all':
                bet = balance
            else:
                bet = int(bet)

            if bet <= 0:
                print("âš ï¸ Sá»‘ tiá»n cÆ°á»£c pháº£i lá»›n hÆ¡n 0.")
            elif bet > balance:
                print("âš ï¸ Báº¡n khÃ´ng Ä‘á»§ tiá»n Ä‘á»ƒ cÆ°á»£c sá»‘ tiá»n nÃ y.")
            else:
                return bet
        except ValueError:
            print("âš ï¸ Vui lÃ²ng nháº­p sá»‘ há»£p lá»‡.")
            # time.sleep(1)
            # clear()  # XÃ³a mÃ n hÃ¬nh náº¿u nháº­p sai

# HÃ m chÆ¡i tÃ i xá»‰u
def choi_tai_xiu(username):
    # Láº¥y thÃ´ng tin ngÆ°á»i chÆ¡i
    player = players_collection.find_one({"username": username})
    balance = player['balance']

    while True:
        print(title2)
        print(f"ğŸ’° **Sá»‘ dÆ° tÃ i khoáº£n**: {balance} PLDCoin")
        cnc = input('ğŸ² Chá»n "tai" hoáº·c "xiu" (nháº­p "thoat" Ä‘á»ƒ dá»«ng): ').lower()
        if cnc == 'thoat':
            break
        if cnc not in ['tai', 'xiu']:
            print("âš ï¸ Vui lÃ²ng chá»n 'tai' hoáº·c 'xiu'.")
            time.sleep(1)
            clear()
            continue

        bet = valid_bet(balance)  # Gá»i hÃ m kiá»ƒm tra cÆ°á»£c há»£p lá»‡

        # Äiá»u chá»‰nh xÃ¡c suáº¥t cho tÃ i vÃ  xiu
        if random.random() <= 0.4:  # 40% chance for 'tai'
            result = 'tai'
        else:  # 60% chance for 'xiu'
            result = 'xiu'

        # Káº¿t quáº£ tÃ i/xá»‰u
        xx1, xx2, xx3 = random.randint(1, 6), random.randint(1, 6), random.randint(1, 6)
        total = xx1 + xx2 + xx3
        print(f"ğŸ²ğŸ²ğŸ² XÃºc xáº¯c:")
        time.sleep(1)
        print("XÃºc xáº¯c 1 ğŸ²: ", xx1)
        time.sleep(1)
        print("XÃºc xáº¯c 2 ğŸ²: ", xx2)
        time.sleep(1)
        print("XÃºc xáº¯c 3 ğŸ²: ", xx3)
        time.sleep(1)
        print("Tá»•ng: ", total)

        if cnc == result:
            balance += bet
            print("ğŸ‰ Báº¡n tháº¯ng!")
        else:
            balance -= bet
            print("ğŸ˜¢ Báº¡n thua!")

        print(f"ğŸ’° **Sá»‘ dÆ° hiá»‡n táº¡i**: {balance} PLDCoin")
        send_to_discord(DISCORD_WEBHOOK_URL, username, balance)

        # Cáº­p nháº­t sá»‘ dÆ° vÃ o MongoDB
        players_collection.update_one({"username": username}, {"$set": {"balance": balance}})
        time.sleep(5)
        clear()


# Main program
title2 = '''
___________      .__       .__        __________.__       .___
\__    ___/____  |__|__  __|__|__ __  \______   \  |    __| _/
  |    |  \__  \ |  \  \/  /  |  |  \  |     ___/  |   / __ | 
  |    |   / __ \|  |>    <|  |  |  /  |    |   |  |__/ /_/ | 
  |____|  (____  /__/__/\_ \__|____/   |____|   |____/\____ | 
               \/         \/                               \/ 
'''

title = '''
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• 
â•šâ•â•      â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•  â•šâ•â•â•â•  
'''

while True:
    os.system('cls' if os.name == 'nt' else 'clear')
    print(title)
    print("-------------------------------")
    print("|1ï¸âƒ£  ÄÄƒng kÃ½ tÃ i khoáº£n")
    print("|2ï¸âƒ£  ÄÄƒng nháº­p")
    print("|3ï¸âƒ£  ThoÃ¡t\n")
    choice = input("ğŸ”§ Lá»±a chá»n cá»§a báº¡n: ").strip()
    if choice == '1':
        if register():
            input("âœ… Nháº¥n Enter Ä‘á»ƒ quay láº¡i menu chÃ­nh...")
    elif choice == '2':
        user = login()
        if user:
            while True:
                os.system('cls' if os.name == 'nt' else 'clear')
                print(title2)
                print("-------------------------------\n")
                print("1ï¸âƒ£  ChÆ¡i tÃ i xá»‰u")
                print("\n2ï¸âƒ£  ÄÄƒng xuáº¥t\n")
                sub_choice = input("ğŸ”§ Lá»±a chá»n cá»§a báº¡n: ").strip()
                if sub_choice == '1':
                    clear()
                    choi_tai_xiu(user)
                elif sub_choice == '2':
                    print("ğŸ‘‹ ÄÄƒng xuáº¥t thÃ nh cÃ´ng!")
                    break
    elif choice == '3':
        print("ğŸ‘‹ Táº¡m biá»‡t! Háº¹n gáº·p láº¡i.")
        break
    else:
        print("âš ï¸ Lá»±a chá»n khÃ´ng há»£p lá»‡.")
